name: Experience

on:
  workflow_dispatch:

  schedule:
    - cron: 17 */6 * * *

env:
  TG_TOKEN: ${{ secrets.TG_TOKEN }}
  TG_CHATID: ${{ secrets.TG_CHATID }}

jobs:
  misc:
    name: Miscellaneous Sites
    runs-on: ubuntu-latest
    steps:
      - name: Sleep Random Time
        run: sleep $(shuf -i 10-60 -n 1)
      - uses: actions/checkout@v2
      - name: Set up Python
        uses: actions/setup-python@v2
        with:
          python-version: 3.8
      - name: Install dependencies
        run: python -m pip install --upgrade requests pyaes flexget Pillow matplotlib pandas chardet python-telegram-bot pyppeteer pyppeteer-stealth colorama
      - name: Hostloc Experience
        env:
          HOSTLOC_USERNAME: ${{ secrets.HOSTLOC_USERNAME }}
          HOSTLOC_PASSWORD: ${{ secrets.HOSTLOC_PASSWORD }}
        run: python Experience/hostloc.py || echo "HOSTLOC_FAIL=true" >> $GITHUB_ENV
      - name: PT Sites
        env:
          REPO_TOKEN: ${{ secrets.REPO_TOKEN }}
          FLEXGET_CONFIG_URL: ${{ secrets.FLEXGET_CONFIG_URL }}
        run: |
          mkdir flexget && cd flexget
          pip install fuzzywuzzy baidu-aip Pillow
          curl -sSL \
            -H "Authorization: token $REPO_TOKEN" \
            $FLEXGET_CONFIG_URL \
            > config.yaml
          git clone https://github.com/madwind/flexget_qbittorrent_mod plugins
          cd plugins && git reset --hard 5ba32c2828c1fae286c44cdd54e48e22f5d9c06f && cd ..
          flexget -c config.yaml execute --task sign_in || echo "FLEXGET_FAIL=true" >> $GITHUB_ENV
      - name: Notify
        if: env.HOSTLOC_FAIL || env.FLEXGET_FAIL
        run: |
          [ $HOSTLOC_FAIL ] && python Notify.py 'Hostloc'
          [ $FLEXGET_FAIL ] && python Notify.py 'Flexget'

  tieba_experience:
    name: TieBa Experience
    runs-on: ubuntu-latest
    steps:
      - name: Sleep Random Time
        run: sleep $(shuf -i 10-60 -n 1)
      - name: Set up JDK 1.8
        uses: actions/setup-java@v1
        with:
          java-version: 1.8
      - name: Clone
        run: git clone --depth 1 https://github.com/BidenJoe/TiebaSignIn Experience
      - name: Experience
        id: tieba_experience
        env:
          BDUSS: ${{ secrets.BAIDU_BDUSS }}
        run: cd Experience && mvn compile exec:java -Dexec.mainClass="top.srcrs.Run" -Dexec.args="${BDUSS} ${PUSHINFO}" || echo "::set-output name=status::Error"
      - uses: actions/checkout@v2
        if: steps.tieba_experience.outputs.status == 'Error'
      - name: Set Python
        if: steps.tieba_experience.outputs.status == 'Error'
        uses: actions/setup-python@v2
        with:
          python-version: 3.x
      - name: Notify
        if: steps.tieba_experience.outputs.status == 'Error'
        run: pip install requests && python Notify.py '贴吧'
